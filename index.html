<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    #usersList {
        display: flex;
        justify-content: center;
        padding-top: 50px;
        flex-direction: column;
        margin: 0 auto;
        width: 400px;
    }

    li {
        list-style: none;
    }
</style>
<body>
    <form>
        <input
            id="name" 
            placeholder="name"
        />
        <input
            id="lastname" 
            placeholder="lastname"
        />
        <input 
            id="password"  
            placeholder="password"
        />
        <input 
            id="age"  
            placeholder="age"
        />
        <button 
            id="registerBtn" 
        >register</button>
    </form>

    <ul id="usersList"></ul>
</body>
<script>
    const name = document.getElementById('name')
    const password = document.getElementById('password')
    const age = document.getElementById('age')
    const lastname = document.getElementById('lastname')
    const registerBtn = document.getElementById('registerBtn')

    const register = async (e) => {
        e.preventDefault()

        await fetch('http://localhost:5000/auth/registration', {
            method: 'POST',
            body: JSON.stringify({
                username: name.value,
                lastname: lastname.value,
                password: password.value,
                age: age.value,
            }),
            headers: {
                'Content-type': 'application/json; charset=UTF-8',
            },
            })
            .then(response => response.json())
            .then((json) => console.log(json));    


        // reset formData
        name.value = ''
        lastname.value = ''
        password.value = ''
        age.value = ''
    }

    registerBtn.addEventListener('click', register)


    const users = fetch('http://localhost:5000/auth/users')
        .then(response => response.json())
        .then(json => {
            const list =  json.map(i => {
                // setTimeout(() => {                    
                //     const deleteUser = document.getElementById(i.username);
                //     deleteUser.addEventListener('click', async i => {
                //         const response = await fetch('http://localhost:5000/auth/delete', {
                //             method: 'DELETE', // *GET, POST, PUT, DELETE, etc.
                //             mode: 'cors', // no-cors, *cors, same-origin
                //             cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                //             credentials: 'same-origin', // include, *same-origin, omit
                //             headers: {
                //             'Content-Type': 'application/json'
                //             // 'Content-Type': 'application/x-www-form-urlencoded',
                //             },
                //             redirect: 'follow', // manual, *follow, error
                //             referrerPolicy: 'no-referrer', // no-referrer, *client
                //             body: JSON.stringify({username}) // body data type must match "Content-Type" header
                //         });
                //         return await response.json();
                //     })
                // }, 500);
                return (
                `<li>
                    name: ${i.username},
                    lastname: ${i.lastname || '-'},
                    age: ${i.age || '-'}
                    <button class="deleteUser" id=${i.username} onclick=>Удалить</button>
                </li>`)
            }); 
            document.getElementById('usersList').innerHTML = list.join('')

            const deleteBtns = Array.from(document.querySelectorAll('.deleteUser'))
            deleteBtns.map(i => {
                i.addEventListener('click', async() => {
                    await fetch('http://localhost:5000/auth/delete', {
                        method: 'DELETE', 
                        mode: 'cors', 
                        cache: 'no-cache', 
                        credentials: 'same-origin', 
                        headers: {
                        'Content-Type': 'application/json'
                        },
                        redirect: 'follow', 
                        referrerPolicy: 'no-referrer', 
                        body: JSON.stringify({username: i.id}) 
                    });
                })
            })
        })
</script>
</html>